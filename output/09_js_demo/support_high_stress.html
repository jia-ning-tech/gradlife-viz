<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Supervisor & institutional support vs high stress</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f7;
      color: #222;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 4px;
    }
    p {
      margin-top: 0;
      color: #555;
      font-size: 13px;
    }
    .panel {
      width: 1000px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
      padding: 16px;
      box-sizing: border-box;
      margin-bottom: 20px;
    }
    .panel-title {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 4px;
    }
    .panel-subtitle {
      font-size: 12px;
      color: #777;
      margin-top: 0;
      margin-bottom: 8px;
    }
    #chart_pie {
      width: 100%;
      height: 380px;
    }
    #chart_bar {
      width: 100%;
      height: 420px;
    }
    #rose_container {
      display: flex;
      gap: 16px;
    }
    #chart_rose_high,
    #chart_rose_low {
      flex: 1;
      height: 360px;
    }
    #chart_bar_degree_compare {
      width: 100%;
      height: 400px;
    }
    .selector-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      font-size: 12px;
      color: #444;
      margin: 6px 0 10px 0;
    }
    .selector-row label {
      font-weight: 500;
      margin-right: 4px;
    }
    .selector-row select {
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 12px;
    }
  </style>
  <!-- ECharts + PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <h1>Supervisor & institutional support vs high-stress status</h1>
  <p>
    Factors (Likert 1–7, recoded as 1–3 low, 4 neutral, 5–7 high):<br/>
    Q27.f – Overall relationship with supervisor<br/>
    Q32.a – Supervisor makes time for frank conversations about my career<br/>
    Q35.a – Mental health & wellbeing services tailored to graduate students<br/>
    Q35.d – Other mental-health/wellbeing support beyond 1:1<br/>
    Q35.e – University supports good work–life balance<br/>
    Data source: viz_support_high_stress_by_degree.csv (Nature Graduate Survey 2022)
  </p>

  <div class="panel">
    <div class="panel-title">Select support factor and degree type</div>
    <div class="selector-row">
      <div>
        <label for="factorSelect">Support factor:</label>
        <select id="factorSelect">
          <option value="v079_num">Q27.f – Overall relationship with supervisor</option>
          <option value="v091_num">Q32.a – Supervisor makes time for career conversations</option>
          <option value="v097_num">Q35.a – Mental-health & wellbeing services tailored</option>
          <option value="v100_num">Q35.d – Other mental-health/wellbeing support beyond 1:1</option>
          <option value="v101_num">Q35.e – University supports good work–life balance</option>
        </select>
      </div>
      <div>
        <label for="degreeSelect">Degree type (for single-degree views):</label>
        <select id="degreeSelect">
          <option value="ALL">All degrees</option>
          <option value="1">Doctorate degree (PhD/DPhil/MD)</option>
          <option value="2">Master's degree (MA/MS/MSc/PSM or other Master’s)</option>
          <option value="3">Dual doctorate degree (MD-PhD, PhD-PhD or other combination)</option>
        </select>
      </div>
    </div>
    <p id="currentFactorText" class="panel-subtitle">
      Q27.f – Overall relationship with supervisor. Viewing: All degrees.
    </p>
  </div>

  <!-- 上：嵌套环状图（单一学位 + All） -->
  <div class="panel">
    <div class="panel-title">Support level and high-stress share (nested donut)</div>
    <p class="panel-subtitle">
      Inner ring: distribution of support levels (low, neutral, high) within the selected degree group.<br/>
      Outer ring: within each support level, split into high-stress vs not high-stress (by count).<br/>
      Clicking a legend item hides/shows that support level in <strong>both inner and outer rings</strong>.
    </p>
    <div id="chart_pie"></div>
  </div>

  <!-- 中：堆叠/分组柱状图（单一学位 + All） -->
  <div class="panel">
    <div class="panel-title">High-stress vs not high-stress by support level (stacked / grouped bar)</div>
    <p class="panel-subtitle">
      Use the toolbox buttons to switch between percentage vs count, and stacked vs grouped bars.
    </p>
    <div id="chart_bar"></div>
  </div>

  <!-- 新：多学位比较柱状图 -->
  <div class="panel">
    <div class="panel-title">Compare high-stress share across degree types</div>
    <p class="panel-subtitle">
      For the selected support factor, this chart compares the <strong>high-stress share</strong> within each support level<br/>
      across degree types (Doctorate, Master’s, Dual). Higher bars = higher proportion of students in the high-stress group<br/>
      within that support level and degree category.
    </p>
    <div id="chart_bar_degree_compare"></div>
  </div>

  <!-- 下：两张玫瑰图（单一学位 + All） -->
  <div class="panel">
    <div class="panel-title">Support-level composition within high-stress vs not high-stress groups (rose charts)</div>
    <p class="panel-subtitle">
      Left: composition of the high-stress group by support level.<br/>
      Right: composition of the not high-stress group by support level.<br/>
      Use toolbox buttons to show/hide labels (frequency and percentage).
    </p>
    <div id="rose_container">
      <div id="chart_rose_high"></div>
      <div id="chart_rose_low"></div>
    </div>
  </div>

  <script>
    const csvPath = "../07_support/viz_support_high_stress_by_degree.csv";

    // 因子元数据
    const FACTOR_META = {
      v079_num: {
        label: "Q27.f – Overall relationship with supervisor",
        desc:
          "How satisfied are you with the following aspect of your degree? Overall relationship with supervisor.",
      },
      v091_num: {
        label: "Q32.a – Supervisor makes time for frank conversations about my career",
        desc: "My supervisor makes time for frank conversations about my career.",
      },
      v097_num: {
        label: "Q35.a – Mental-health & wellbeing services tailored to graduate students",
        desc:
          "Mental health and wellbeing services in my university are tailored and appropriate to the needs of graduate students.",
      },
      v100_num: {
        label:
          "Q35.d – Other types of mental health/wellbeing support beyond 1:1",
        desc:
          "My university offers different types of support to promote mental health and wellbeing beyond one-to-one support.",
      },
      v101_num: {
        label: "Q35.e – University supports good work–life balance",
        desc: "My university supports good work–life balance.",
      },
    };

    // 学位元数据（code -> label）
    const DEGREE_META = {
      ALL: "All degrees",
      "1": "Doctorate degree (PhD/DPhil/MD)",
      "2": "Master's degree (MA/MS/MSc/PSM or other Master’s)",
      "3": "Dual doctorate degree (MD-PhD, PhD-PhD or other combination)",
    };

    const LEVEL_ORDER = [
      "Low support (1–3)",
      "Neutral (4)",
      "High support (5–7)",
    ];

    function shortLevelLabel(level) {
      if (level.startsWith("Low support")) return "Low";
      if (level.startsWith("High support")) return "High";
      if (level.startsWith("Neutral")) return "Neutral";
      return level;
    }

    // 读 CSV
    fetch(csvPath)
      .then((resp) => resp.text())
      .then((text) => {
        const parsed = Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
        });
        const rows = parsed.data;

        // dataByFactor[factor][degreeCode] = rowList
        const dataByFactor = {};

        rows.forEach((r) => {
          const f = r.factor;
          const degCodeRaw = r.degree_code_int;
          if (degCodeRaw === "" || degCodeRaw == null) return;
          const degCode = String(parseInt(degCodeRaw, 10));
          if (!dataByFactor[f]) dataByFactor[f] = {};
          if (!dataByFactor[f][degCode]) dataByFactor[f][degCode] = [];
          dataByFactor[f][degCode].push(r);
        });

        function collectRowsForFactorAndDegree(factorKey, degreeFilter) {
          const factorObj = dataByFactor[factorKey] || {};
          if (degreeFilter === "ALL") {
            // 合并所有学位
            let allRows = [];
            Object.keys(factorObj).forEach((deg) => {
              allRows = allRows.concat(factorObj[deg]);
            });
            return allRows;
          } else {
            return factorObj[degreeFilter] ? factorObj[degreeFilter].slice() : [];
          }
        }

        function prepareFactorData(factorKey, degreeFilter) {
          const rows = collectRowsForFactorAndDegree(factorKey, degreeFilter);
          const levelStat = {}; // level -> { high, low }

          rows.forEach((r) => {
            const level = r.level;
            const hs = parseInt(r.high_stress_group, 10);
            const c = parseInt(r.count, 10);
            if (!levelStat[level]) {
              levelStat[level] = { high: 0, low: 0 };
            }
            if (hs === 1) {
              levelStat[level].high += c;
            } else {
              levelStat[level].low += c;
            }
          });

          const levels = Object.keys(levelStat).sort(
            (a, b) => LEVEL_ORDER.indexOf(a) - LEVEL_ORDER.indexOf(b)
          );

          const highCounts = [];
          const lowCounts = [];
          const totalCounts = [];
          const highWithin = [];
          const lowWithin = [];

          let totalSample = 0;
          let totalHigh = 0;
          let totalLow = 0;

          levels.forEach((lvl) => {
            const st = levelStat[lvl];
            const high = st.high;
            const low = st.low;
            const tot = high + low;
            const hp = tot > 0 ? (high / tot) * 100 : 0;
            const lp = tot > 0 ? (low / tot) * 100 : 0;

            highCounts.push(high);
            lowCounts.push(low);
            totalCounts.push(tot);
            highWithin.push(hp);
            lowWithin.push(lp);

            totalSample += tot;
            totalHigh += high;
            totalLow += low;
          });

          return {
            levels,
            highCounts,
            lowCounts,
            totalCounts,
            highWithin,
            lowWithin,
            totalSample,
            totalHigh,
            totalLow,
          };
        }

        const baseColors = ["#f97373", "#fbbf24", "#34d399"]; // 低 / 中 / 高

        // 初始化图表实例
        const pieDom = document.getElementById("chart_pie");
        const pieChart = echarts.init(pieDom);

        const barDom = document.getElementById("chart_bar");
        const barChart = echarts.init(barDom);

        const roseHighDom = document.getElementById("chart_rose_high");
        const roseLowDom = document.getElementById("chart_rose_low");
        const roseHighChart = echarts.init(roseHighDom);
        const roseLowChart = echarts.init(roseLowDom);

        const degreeCompareDom = document.getElementById("chart_bar_degree_compare");
        const degreeCompareChart = echarts.init(degreeCompareDom);

        let currentFactorKey = "v079_num";
        let currentDegreeFilter = "ALL";
        let barScale = "percent";   // 'percent' | 'count'
        let barLayout = "stacked";  // 'stacked' | 'grouped'
        let roseLabelMode = "show"; // 'show' | 'hide'

        // 嵌套环状图（修正版：n>10 才显示标签 + toolbox 不压标题）
        function makeDonutOption(factorKey, degreeFilter) {
          const meta = FACTOR_META[factorKey];
          const degLabel = DEGREE_META[degreeFilter] || "All degrees";
          const data = prepareFactorData(factorKey, degreeFilter);

          const innerData = data.levels.map((lvl, idx) => {
            const tot = data.totalCounts[idx];
            const share = data.totalSample > 0 ? (tot / data.totalSample) * 100 : 0;
            return {
              name: shortLevelLabel(lvl),
              value: tot,
              level: "inner",
              fullLabel: lvl,
              totalCount: tot,
              totalShare: share,
              itemStyle: {
                color: baseColors[idx % baseColors.length],
              },
            };
          });

          const outerData = [];
          data.levels.forEach((lvl, idx) => {
            const tot = data.totalCounts[idx];
            const hc = data.highCounts[idx];
            const lc = data.lowCounts[idx];
            const hp = data.highWithin[idx];
            const lp = data.lowWithin[idx];
            const base = baseColors[idx % baseColors.length];

            // 这里阈值改为 n > 10
            const showHighLabel = hc > 0;
            const showLowLabel = lc > 0;
            const nameShort = shortLevelLabel(lvl);

            outerData.push({
              name: nameShort,
              value: hc,
              level: "outer",
              status: "High-stress",
              categoryShort: nameShort,
              fullLabel: lvl,
              count: hc,
              withinPercent: hp,
              totalCount: tot,
              showLabel: showHighLabel,
              itemStyle: { color: base },
              labelLine: { show: showHighLabel },
            });

            outerData.push({
              name: nameShort,
              value: lc,
              level: "outer",
              status: "Not high-stress",
              categoryShort: nameShort,
              fullLabel: lvl,
              count: lc,
              withinPercent: lp,
              totalCount: tot,
              showLabel: showLowLabel,
              itemStyle: { color: echarts.color.lift(base, 0.4) },
              labelLine: { show: showLowLabel },
            });
          });

          return {
            title: {
              text: meta.label + " – " + degLabel,
              left: "center",
              top: 4,
              textStyle: { fontSize: 14, fontWeight: 600 },
            },
            tooltip: {
              trigger: "item",
              formatter: (params) => {
                const d = params.data;
                if (d.level === "inner") {
                  return [
                    `<strong>${d.fullLabel}</strong>`,
                    `Degree group: ${degLabel}`,
                    `Total respondents: ${d.totalCount}`,
                    `Share of this degree group: ${d.totalShare.toFixed(1)}%`,
                  ].join("<br/>");
                } else if (d.level === "outer") {
                  return [
                    `<strong>${d.fullLabel}</strong>`,
                    `Degree group: ${degLabel}`,
                    `Status: ${d.status}`,
                    `Count: ${d.count}`,
                    `Within this level: ${d.withinPercent.toFixed(1)}%`,
                    `Total in this level: ${d.totalCount}`,
                  ].join("<br/>");
                }
                return params.name;
              },
            },
            legend: {
              bottom: 0,
              type: "scroll",
              data: data.levels.map((lvl) => shortLevelLabel(lvl)),
            },
            toolbox: {
              top: 34,      // 往下挪，避免压住标题
              right: 10,
              feature: {
                saveAsImage: { show: true },
                dataView: { show: true, readOnly: false },
                restore: { show: true },
              },
            },
            series: [
              {
                name: meta.label + " – levels",
                type: "pie",
                selectedMode: "single",
                radius: [0, "30%"],
                center: ["50%", "52%"],
                label: {
                  position: "inner",
                  fontSize: 13,
                  formatter: (p) => {
                    const d = p.data;
                    if (!isFinite(d.totalShare)) return "";
                    return `${d.name}\n${d.totalShare.toFixed(1)}%`;
                  },
                },
                labelLine: { show: false },
                data: innerData,
              },
              {
                name: meta.label + " – high vs not high",
                type: "pie",
                radius: ["45%", "65%"],
                center: ["50%", "52%"],
                labelLayout: {
                  hideOverlap: false,
                  moveOverlap: "shiftY",
                },
                labelLine: {
                  length: 30,
                  length2: 14,
                },
                label: {
                  formatter: (params) => {
                    const d = params.data;
                    if (!d.showLabel) return "";
                    return `{cat|${d.categoryShort} - ${d.status}}{abg|}\n{hr|}\n  {cnt|n=${d.count}}  {per|${d.withinPercent.toFixed(1)}%}`;
                  },
                  backgroundColor: "#F6F8FC",
                  borderColor: "#8C8D8E",
                  borderWidth: 1,
                  borderRadius: 4,
                  rich: {
                    cat: {
                      color: "#6E7079",
                      lineHeight: 20,
                      fontSize: 12,
                      fontWeight: "bold",
                    },
                    abg: {
                      backgroundColor: "#F6F8FC",
                      height: 0,
                      width: "100%",
                      align: "center",
                    },
                    hr: {
                      borderColor: "#8C8D8E",
                      width: "100%",
                      borderWidth: 0.5,
                      height: 0,
                    },
                    cnt: {
                      color: "#4C5058",
                      fontSize: 12,
                      lineHeight: 18,
                    },
                    per: {
                      color: "#fff",
                      backgroundColor: "#4C5058",
                      padding: [2, 4],
                      borderRadius: 4,
                      fontSize: 11,
                    },
                  },
                },
                data: outerData,
              },
            ],
          };
        }

        // 单学位 / ALL 的柱状图
        function makeBarOption(factorKey, degreeFilter) {
          const meta = FACTOR_META[factorKey];
          const degLabel = DEGREE_META[degreeFilter] || "All degrees";
          const data = prepareFactorData(factorKey, degreeFilter);

          const showPercent = barScale === "percent";
          const stacked = barLayout === "stacked";

          const yName = showPercent ? "Share (%)" : "Count";
          const yMax = showPercent
            ? 100
            : Math.ceil(Math.max(...data.totalCounts, 1) / 50) * 50;

          const seriesHighData = showPercent ? data.highWithin : data.highCounts;
          const seriesLowData = showPercent ? data.lowWithin : data.lowCounts;

          const stackName = stacked ? "total" : undefined;
          const barWidth = stacked ? "45%" : "30%";
          const barGap = stacked ? "-100%" : "20%";

          const xLabels = data.levels.map((lvl) => shortLevelLabel(lvl));

          return {
            title: {
              text: meta.label + " – " + degLabel,
              left: "center",
              top: 4,
              textStyle: { fontSize: 14, fontWeight: 600 },
            },
            toolbox: {
              right: 20,
              feature: {
                saveAsImage: { show: true },
                dataView: { show: true, readOnly: false },
                restore: {
                  show: true,
                  onclick: () => {
                    barScale = "percent";
                    barLayout = "stacked";
                    barChart.setOption(makeBarOption(currentFactorKey, currentDegreeFilter), true);
                  },
                },
                myPercent: {
                  show: true,
                  title: "Show percentage",
                  icon: "path://M512 64L64 960h896L512 64z",
                  onclick: () => {
                    barScale = "percent";
                    barChart.setOption(makeBarOption(currentFactorKey, currentDegreeFilter), true);
                  },
                },
                myCount: {
                  show: true,
                  title: "Show count",
                  icon: "path://M128 832h768v-128H128v128zM128 576h768V448H128v128zM128 320h768V192H128v128z",
                  onclick: () => {
                    barScale = "count";
                    barChart.setOption(makeBarOption(currentFactorKey, currentDegreeFilter), true);
                  },
                },
                myStack: {
                  show: true,
                  title: "Stacked bars",
                  icon: "path://M128 832h256v-256H128v256zM384 832h256v-256H384v256zM640 832h256v-256H640v256zM128 576h256V320H128v256zM384 576h256V320H384v256zM640 576h256V320H640v256z",
                  onclick: () => {
                    barLayout = "stacked";
                    barChart.setOption(makeBarOption(currentFactorKey, currentDegreeFilter), true);
                  },
                },
                myGrouped: {
                  show: true,
                  title: "Grouped bars",
                  icon: "path://M192 832h160V320H192v512zM432 832h160V448H432v384zM672 832h160V192H672v640z",
                  onclick: () => {
                    barLayout = "grouped";
                    barChart.setOption(makeBarOption(currentFactorKey, currentDegreeFilter), true);
                  },
                },
                dataZoom: { show: true },
              },
            },
            legend: {
              top: 26,
              data: ["High-stress", "Not high-stress"],
            },
            grid: { left: 80, right: 40, top: 60, bottom: 80 },
            tooltip: {
              trigger: "axis",
              axisPointer: { type: "shadow" },
              formatter: (params) => {
                const idx = params[0].dataIndex;
                const lvl = data.levels[idx];
                const hp = data.highWithin[idx];
                const lp = data.lowWithin[idx];
                const hc = data.highCounts[idx];
                const lc = data.lowCounts[idx];
                const tot = data.totalCounts[idx];

                return [
                  `<strong>${lvl}</strong>`,
                  `Degree group: ${degLabel}`,
                  `Total in this level: ${tot}`,
                  `<span style="color:#f97373;">■</span> High-stress: ` +
                    (showPercent ? `${hp.toFixed(1)}% (${hc})` : hc),
                  `<span style="color:#34d399;">■</span> Not high-stress: ` +
                    (showPercent ? `${lp.toFixed(1)}% (${lc})` : lc),
                ].join("<br/>");
              },
            },
            xAxis: {
              type: "category",
              data: xLabels,
              axisLabel: {
                interval: 0,
                rotate: 0,
                fontSize: 12,
              },
            },
            yAxis: {
              type: "value",
              name: yName,
              min: 0,
              max: yMax,
            },
            dataZoom: [
              { type: "slider", show: false, xAxisIndex: 0, bottom: 60 },
              { type: "inside", xAxisIndex: 0 },
            ],
            series: [
              {
                name: "High-stress",
                type: "bar",
                stack: stackName,
                data: seriesHighData,
                barWidth: barWidth,
                barGap: barGap,
                itemStyle: {
                  color: "#f97373",
                  borderRadius: stacked ? [6, 6, 0, 0] : [4, 4, 4, 4],
                },
                label: {
                  show: true,
                  position: "inside",
                  formatter: (p) => {
                    const idx = p.dataIndex;
                    if (showPercent) {
                      const pct = data.highWithin[idx];
                      if (!isFinite(pct) || pct < 5) return "";
                      return `${pct.toFixed(1)}%\n(${data.highCounts[idx]})`;
                    } else {
                      const val = data.highCounts[idx];
                      if (!isFinite(val) || val < data.totalCounts[idx] * 0.05)
                        return "";
                      return val.toString();
                    }
                  },
                },
              },
              {
                name: "Not high-stress",
                type: "bar",
                stack: stackName,
                data: seriesLowData,
                barWidth: barWidth,
                barGap: barGap,
                itemStyle: {
                  color: "#34d399",
                  borderRadius: stacked ? [0, 0, 6, 6] : [4, 4, 4, 4],
                },
                label: {
                  show: true,
                  position: "inside",
                  formatter: (p) => {
                    const idx = p.dataIndex;
                    if (showPercent) {
                      const pct = data.lowWithin[idx];
                      if (!isFinite(pct) || pct < 5) return "";
                      return `${pct.toFixed(1)}%\n(${data.lowCounts[idx]})`;
                    } else {
                      const val = data.lowCounts[idx];
                      if (!isFinite(val) || val < data.totalCounts[idx] * 0.05)
                        return "";
                      return val.toString();
                    }
                  },
                },
              },
            ],
          };
        }

        // 多学位比较柱状图（高压比例）
        // 多学位比较柱状图（高压比例，一次显示三个学位）
        function makeDegreeCompareOption(factorKey) {
          const meta = FACTOR_META[factorKey];
          const factorObj = dataByFactor[factorKey] || {};

          // 固定学位顺序：1 博士, 2 硕士, 3 双学位（只保留在数据中存在的学位）
          const degreeCodes = ["1", "2", "3"].filter((code) => factorObj[code]);
          const degreeNames = degreeCodes.map(
            (code) => DEGREE_META[code] || `Degree ${code}`
          );

          // 收集所有出现过的 support level
          const levelSet = new Set();
          degreeCodes.forEach((code) => {
            const rows = factorObj[code] || [];
            rows.forEach((r) => {
              if (r.level) levelSet.add(r.level);
            });
          });

          const levels = Array.from(levelSet).sort(
            (a, b) => LEVEL_ORDER.indexOf(a) - LEVEL_ORDER.indexOf(b)
          );

          // 构造 degree -> level -> { pct, count, total }
          const degLevelStat = {};
          degreeCodes.forEach((code) => {
            degLevelStat[code] = {};
            const rows = factorObj[code] || [];

            // 先把该学位下所有 level 的总样本记下来
            const tmpTotal = {};
            rows.forEach((r) => {
              const lvl = r.level;
              const c = parseInt(r.count, 10) || 0;
              if (!tmpTotal[lvl]) tmpTotal[lvl] = 0;
              tmpTotal[lvl] += c;
            });

            // 再记录 high-stress 的比例（percent 列是在这个 level 内的比例）
            rows.forEach((r) => {
              if (String(r.high_stress_group) !== "1") return;
              const lvl = r.level;
              let p = parseFloat(r.percent);
              if (!isFinite(p)) p = 0;
              const c = parseInt(r.count, 10) || 0;
              const tot = tmpTotal[lvl] || 0;
              degLevelStat[code][lvl] = {
                pct: p,
                count: c,
                total: tot,
              };
            });
          });

          // 为每个学位构造 series
          const series = degreeCodes.map((code, idx) => {
            const dataArr = levels.map((lvl) => {
              const st = degLevelStat[code][lvl];
              return st ? st.pct : 0;
            });
            return {
              name: DEGREE_META[code] || `Degree ${code}`,
              type: "bar",
              data: dataArr,
              barGap: 0,
              barCategoryGap: "40%",
              itemStyle: {
                color: echarts.color.lift(baseColors[idx % baseColors.length], 0.0),
                borderRadius: [4, 4, 4, 4],
              },
              label: {
                show: true,
                position: "top",
                formatter: (p) => {
                  const v = p.value;
                  if (!isFinite(v) || v < 5) return "";
                  return v.toFixed(1) + "%";
                },
              },
            };
          });

          return {
            title: {
              text:
                meta.label +
                " – high-stress share by degree & support level",
              left: "center",
              top: 4,
              textStyle: { fontSize: 14, fontWeight: 600 },
            },
            tooltip: {
              // ✅ 用 axis 触发，一次显示所有学位
              trigger: "axis",
              axisPointer: { type: "shadow" },
              confine: true,
              formatter: (params) => {
                // params 是一个数组，里面有三个学位各自的柱
                if (!params || !params.length) return "";
                const idx = params[0].dataIndex;          // 支持水平的下标
                const lvlFull = levels[idx];              // 完整的 support level 文本
                const lines = [
                  `<strong>${lvlFull}</strong>`,
                  "High-stress share within this support level:",
                ];
                params.forEach((p) => {
                  const v = p.value;
                  const vText = isFinite(v) ? v.toFixed(1) + "%" : "0.0%";
                  lines.push(`${p.marker} ${p.seriesName}: ${vText}`);
                });
                return lines.join("<br/>");
              },
            },
            legend: {
              top: 26,
              data: degreeNames,
            },
            toolbox: {
              right: 20,
              top: 36,
              feature: {
                saveAsImage: { show: true },
                dataView: { show: true, readOnly: false },
                restore: { show: true },
              },
            },
            grid: { left: 70, right: 40, top: 70, bottom: 80 },
            xAxis: {
              type: "category",
              data: levels.map((lvl) => shortLevelLabel(lvl)),
              axisLabel: { interval: 0, fontSize: 12 },
            },
            yAxis: {
              type: "value",
              name: "High-stress share within level (%)",
              min: 0,
              max: 100,
            },
            series,
          };
        }
        

        // 玫瑰图
        function makeRoseOption(factorKey, degreeFilter, isHigh) {
          const meta = FACTOR_META[factorKey];
          const degLabel = DEGREE_META[degreeFilter] || "All degrees";
          const data = prepareFactorData(factorKey, degreeFilter);

          const values = isHigh ? data.highCounts : data.lowCounts;
          const total = isHigh ? data.totalHigh : data.totalLow;
          const titleText =
            (isHigh ? "High-stress group – " : "Not high-stress group – ") +
            degLabel;
          const seriesName = titleText;

          return {
            title: {
              text: titleText,
              left: "center",
              top: 6,
              textStyle: { fontSize: 13 },
            },
            tooltip: {
              trigger: "item",
              formatter: (params) => {
                const v = params.data.value;
                const pct = total > 0 ? (v / total) * 100 : 0;
                return [
                  `<strong>${params.data.fullLabel}</strong>`,
                  `${seriesName}`,
                  `n = ${v}`,
                  `Share in this group: ${pct.toFixed(1)}%`,
                ].join("<br/>");
              },
            },
            legend: {
              type: "scroll",
              bottom: 0,
              data: data.levels.map((lvl) => shortLevelLabel(lvl)),
            },
            toolbox: {
              right: 10,
              feature: {
                saveAsImage: { show: true },
                dataView: { show: true, readOnly: false },
                restore: { show: true },
                myShowLabels: {
                  show: true,
                  title: "Show labels (n & %)",
                  icon: "path://M512 64L64 960h896L512 64z",
                  onclick: () => {
                    roseLabelMode = "show";
                    updateRoseCharts();
                  },
                },
                myHideLabels: {
                  show: true,
                  title: "Hide labels",
                  icon: "path://M128 832h768v-128H128v128z",
                  onclick: () => {
                    roseLabelMode = "hide";
                    updateRoseCharts();
                  },
                },
              },
            },
            series: [
              {
                name: seriesName,
                type: "pie",
                roseType: "area",
                radius: [20, 120],
                center: ["50%", "50%"],
                itemStyle: { borderRadius: 5 },
                label: {
                  show: roseLabelMode === "show",
                  formatter: (p) => {
                    const v = p.data.value;
                    const pct = total > 0 ? (v / total) * 100 : 0;
                    return `${p.data.name}\n n=${v} (${pct.toFixed(1)}%)`;
                  },
                },
                emphasis: {
                  label: { show: true },
                },
                data: data.levels.map((lvl, idx) => ({
                  name: shortLevelLabel(lvl),
                  fullLabel: lvl,
                  value: values[idx],
                  itemStyle: {
                    color: baseColors[idx % baseColors.length],
                  },
                })),
              },
            ],
          };
        }

        function updateRoseCharts() {
          roseHighChart.setOption(
            makeRoseOption(currentFactorKey, currentDegreeFilter, true),
            true
          );
          roseLowChart.setOption(
            makeRoseOption(currentFactorKey, currentDegreeFilter, false),
            true
          );
        }

        function updateAllCharts() {
          pieChart.setOption(
            makeDonutOption(currentFactorKey, currentDegreeFilter),
            true
          );
          barChart.setOption(
            makeBarOption(currentFactorKey, currentDegreeFilter),
            true
          );
          updateRoseCharts();
          degreeCompareChart.setOption(
            makeDegreeCompareOption(currentFactorKey),
            true
          );

          const meta = FACTOR_META[currentFactorKey];
          const degLabel = DEGREE_META[currentDegreeFilter] || "All degrees";
          const textDom = document.getElementById("currentFactorText");
          textDom.textContent =
            meta.label + " – " + meta.desc + " Viewing: " + degLabel + ".";
        }

        // 初始化为 v079_num + All degrees
        updateAllCharts();

        const factorSelector = document.getElementById("factorSelect");
        factorSelector.addEventListener("change", () => {
          currentFactorKey = factorSelector.value;
          updateAllCharts();
        });

        const degreeSelector = document.getElementById("degreeSelect");
        degreeSelector.addEventListener("change", () => {
          currentDegreeFilter = degreeSelector.value;
          updateAllCharts();
        });
      })
      .catch((err) => {
        console.error("Error loading CSV:", err);
        document.getElementById("chart_pie").innerHTML =
          "<p>Failed to load CSV. Please check the csvPath setting in the script.</p>";
      });
  </script>
</body>
</html>
